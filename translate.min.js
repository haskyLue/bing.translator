var https=require("https"),http=require("http"),querystring=require("querystring"),fs=require("fs"),client={},credentials={},regx=/<string [a-zA-Z0-9=":/.]+>(.*)<\/string>/,token_path="/usr/local/lib/bing.translator/token";
client.setCredentials=function(a){client.credentials=a;};client.isTokenFresh=function(c,b,a){return(c-b)/1000>a?false:true;};client.translate=function(a,d,c,b){console.log(token);
client.getToken(client.credentials,function(g,e){var f=http.request({host:"api.microsofttranslator.com",path:"/V2/Http.svc/Translate?text="+encodeURIComponent(a)+"&from="+d+"&to="+c+"&contentType=text/plain",method:"GET",headers:{Authorization:"Bearer "+e.access_token}});
f.on("response",function(h){var i="";h.on("data",function(j){i+=j;});h.on("end",function(j){console.log(i);b(j,{original_text:a,translated_text:regx.exec(i)[1],from_language:d,to_language:c});
});});f.on("error",function(h){});f.end();});};client.getToken=function(b,c){function a(){var e=querystring.stringify({grant_type:"client_credentials",scope:"http://api.microsofttranslator.com",client_id:b.client_id,client_secret:b.client_secret});
var d=https.request({hostname:"datamarket.accesscontrol.windows.net",port:443,path:"/v2/OAuth2-13/",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":e.length},},function(f){f.setEncoding("utf8");
f.on("data",function(g){g=JSON.parse(g);c(null,g);g.req_time=new Date().getTime();fs.writeFile("token",JSON.stringify(g),{encoding:"utf8"},function(h){if(h){console.log(h);
}console.log("i've got or refresh token & save it!");});});});d.on("error",function(f){return;});d.write(e);d.end();}fs.readFile("token",function(d,e){if(d){console.log(d);
a();return;}var e=e&&JSON.parse(e);if(e&&client.isTokenFresh(new Date().getTime(),e.req_time*1,e.expires_in*1)){c(null,e);}else{a();}});};exports.init=function(a){client.credentials=a;
return client;};